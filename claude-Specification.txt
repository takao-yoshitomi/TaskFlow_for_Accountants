#この仕様書には絵文字は使用しないでください


● 事業者管理アプリ - 最新版仕様書

  プロジェクト概要

  Supabase + Vercel サーバーレス完全移行版事業者管理アプリケーション

- 本番URL: https://mori-jigyosya.vercel.app/
- Supabase Project: https://ocfljsoxxgmnzqlquchx.supabase.co
- リポジトリ: 

  技術スタック

  フロントエンド

  - HTML/CSS/JavaScript (Vanilla)
  - ホスティング: Vercel (サーバーレス)
  - 認証: Google OAuth 2.0
  - UI: カスタムドロップダウン、アコーディオンメニュー、モダントースト通知、テーブルリサイズ

  バックエンド・データベース

  - データベース: Supabase PostgreSQL
  - 認証: Supabase Auth (Google OAuth連携)
  - API: Supabase REST API + Edge Functions
  - 自動化: pg_cron拡張による定期処理
  - リアルタイム: Supabaseリアルタイム機能

  データベース構造

1. app_links

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
name
varchar
NOT NULL
url
text
NOT NULL
display_order
integer
DEFAULT 0
created_at
timestamp
DEFAULT now()

2. backup_history

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
backup_date
timestamp
backup_type
varchar
status
varchar
file_name
varchar
file_size_kb
integer
total_records
integer
error_message
text
created_at
timestamp
DEFAULT now()

3. clients

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
name
varchar
NOT NULL
fiscal_month
integer
CHECK (1–12)
staff_id
integer
FK → staffs.id
accounting_method
varchar
DEFAULT '記帳代行'
status
varchar
DEFAULT 'active'
custom_tasks_by_year
jsonb
DEFAULT '{}'
finalized_years
jsonb
DEFAULT '[]'
overall_memo
text
DEFAULT ''
created_at
timestamp
DEFAULT now()
updated_at
timestamp
DEFAULT now()

4. default_tasks

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
task_name
varchar
accounting_method
varchar
tasks
jsonb
display_order
integer
DEFAULT 0
is_active
boolean
DEFAULT true
created_at
timestamp
DEFAULT now()
updated_at
timestamp
DEFAULT now()

5. editing_sessions

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
client_id
integer
FK → clients.id
user_id
varchar
NOT NULL
started_at
timestamp
DEFAULT now()
last_activity
timestamp
DEFAULT now()

6. monthly_tasks

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
client_id
integer
FK → clients.id
month
varchar
NOT NULL
tasks
jsonb
DEFAULT '{}'
status
varchar
DEFAULT 'pending'
url
text
memo
text
created_at
timestamp
DEFAULT now()
updated_at
timestamp
DEFAULT now()
task_memos
jsonb
DEFAULT '{}'
completed
boolean
NOT NULL, DEFAULT false

7. settings

Column
Type
Constraints / Default
Keys
key
varchar
NOT NULL
PK
value
jsonb
NOT NULL
created_at
timestamp
DEFAULT now()
updated_at
timestamp
DEFAULT now()

8. staffs

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
name
varchar
NOT NULL
email
varchar
role
varchar
DEFAULT 'staff'
created_at
timestamp
DEFAULT now()
updated_at
timestamp
DEFAULT now()

Relationships (Foreign Keys)
clients.staff_id → staffs.id
editing_sessions.client_id → clients.id
monthly_tasks.client_id → clients.id


  認証・セキュリティ

  Google OAuth認証

  - 認証プロバイダー: Google OAuth 2.0
- 承認済みオリジン: https://mori-jigyosya.vercel.app
  - セッション管理: Supabase Auth自動管理
  - ログイン頻度: 1日1回認証（自動セッション管理）

  Row Level Security (RLS) - 実装完了
  - データアクセス制御: Supabase RLS
  - 認証必須: 未ログイン時はデータアクセス不可
  - Anon Key: 公開（フロントエンド用、RLSで保護）

  主要機能

  1. クライアント管理

  - 一覧表示: 担当者別フィルター、検索機能
  - CRUD操作: 追加、編集、削除、再有効化
  - 関与終了機能: 業務終了クライアントのステータス管理
    ├── グレーアウト表示: 設定により非表示/グレー表示切替
    ├── 復活機能: 関与終了状態からの復帰
    └── 管理者権限削除: 物理削除は管理者のみ実行可能
  - カスタムタスク設定: クライアント独自の項目設定
  - 年度確定機能: 特定年度のタスク項目ロック
  - 全体メモ機能: クライアント全体に関するメモ記録・保存

  1.5. 担当者管理機能

  - CRUD操作: 担当者の追加・編集・削除（削除制限機能付き）
  - 割り当て管理: 担当クライアント数の自動集計・表示
  - 削除制限: 担当クライアントが存在する場合の削除防止機能
  - CSV抽出機能: 担当者情報の完全エクスポート
    ├── 出力項目: ID、担当者名、メール、権限、担当クライアント数、担当先一覧、作成・更新日時
    ├── 権限日本語化: admin→管理者、staff→担当者の自動変換
    ├── Excel対応: BOM付きUTF-8エンコーディング
    └── 担当先一覧: セミコロン区切りでの複数クライアント名表示
  - UI最適化: モーダルサイズ調整（700px幅、85vh高さ制限）

  2. 月次進捗管理

  - 進捗入力: チェックボックス形式
  - ステータス表示: `completed`フラグに基づき、最後に完了した年月を表示
  - 自動完了機能: 詳細画面でタスクを100%にして保存すると、自動で`completed`フラグが更新され、10種類の達成時エフェクトからランダムに1つが再生される
  - URL・メモ: 各月次記録に付加情報

  3. タスク項目管理

  - デフォルトタスク: 全クライアント共通の初期項目
  - カスタムタスク: クライアント別独自項目
  - 年度継承: 新年度アクセス時の前年度項目継承
  - タスク伝播: 項目変更時の未確定年度への反映

  4. 年度確定システム

  - 確定機能: 特定年度のタスク項目をロック
  - 編集制限: 確定済み年度は編集不可
  - 継承制御: 確定済み項目の新年度継承

  5. データ管理

  - **自動バックアップシステム**: Supabase Edge Functions + Cron Job による24時間365日自動実行
    ├── 毎日0:00（JST）自動実行: pg_cron スケジューラによる確実な実行
    ├── 週次ローテーション: Sunday-Saturday フォルダでストレージ最適化
    ├── クラウドストレージ: Supabase Storage による安全な保管
    ├── 実行履歴管理: backup_history テーブルでの監視・トラッキング
    └── 緊急時手動実行: アプリUI からの即座バックアップ機能
  - **手動バックアップシステム**: JSON形式・週次ローテーション・File System Access API対応
  - **安全な復元機能**: 外部キー制約・データ整合性完全保証
  - CSVエクスポート: UTF-8 BOM付きExcel対応
  - CSVインポート: 複数エンコーディング対応
  - データベース初期化: 完全リセット機能

  6. 編集制御

  - 悲観ロック: 編集競合防止
  - 強制解除: 編集セッション強制終了
  - 自動タイムアウト: 一定時間後の自動解除

  7. UI/UX改善機能

  - モダントースト通知システム
  - テーブル列幅調整システム

  8. その他アプリ連携機能

  - リンク管理: モーダル画面でのURLリンク管理（名称・URL）
  - CRUD操作: 追加・削除・保存に対応
  - 表示順変更: ドラッグ＆ドロップによる並べ替え
  - 動的ボタン生成: メイン画面のアコーディオン内に、登録したリンクをボタンとして動的生成
  - 外部リンク遷移: ボタンクリックで設定したURLを新しいタブで開く

  9. 高度分析機能付き進捗管理ダッシュボード

  **フェーズ1: 進捗管理ダッシュボード** - 実装完了
  - **多条件フィルター**: 期間・担当者・決算月での絞り込み
  - **動的サマリー**: 全体進捗率・完了タスク数・要注意クライアント自動検出
  - **進捗マトリクス表**: 事業者×年月のマトリクス表示
  - **完全ソート機能**: 事業者名・進捗率・担当者・決算月・月別進捗での並び替え
  - **月別進捗列**: 選択期間に応じた動的列生成
  - **カラーコード表示**: 緑（80%以上）/黄（50-79%）/赤（50%未満）
  - **エクスポート機能**: CSV・Excel（3種類）・PDF形式での出力
    ├── Excel統合シート: サマリーと進捗マトリクスを1シートに統合
    ├── Excel進捗表示: 基本・ヘッダー強調・アイコン付きの3形式
    └── PDF横向き出力: 月次データの色分け表示対応

  **フェーズ2: 担当者別パフォーマンスダッシュボード** - 実装完了
  - **パフォーマンス指標**: 担当クライアント数・平均完了率・完了月数・遅延発生月数
  - **4段階評価システム**: 優秀（95%以上）/良好（85-94%）/標準（70-84%）/要改善（70%未満）
  - **柔軟期間設定**: 今年度・前四半期・6ヶ月・12ヶ月・カスタム期間対応
  - **完全ソート機能**: 全パフォーマンス指標でのソート対応
  - **詳細確認連携**: ワンクリックで進捗ダッシュボードへ遷移
  - **相互ナビゲーション**: 進捗⟷パフォーマンスダッシュボード間の移動

  ユーザーインターフェース

  メイン画面

  - 検索バー: 事業所名・担当者名での絞り込み
  - フィルター: 担当者別、月別、ステータス別
  - 一覧表示: デスクトップはテーブル形式、モバイルはカード形式で自動切替
  - **固定テーブルヘッダー**: スクロール時でも常時表示・項目確認が容易
  - **分析機能ボタン**: 独立配置で全員がアクセス可能
  - アコーディオンメニュー: 「管理メニュー」と「その他アプリ」の2種類を配置
  - テーブル列幅調整: ドラッグ&ドロップで列幅をカスタマイズ
  - トースト通知: 右下からの優雅な通知システム
  - レスポンシブ対応: 480px以下でモバイル専用UI に自動変換

  管理メニュー

  - 管理メニュー
    ├── 担当者管理（CSV抽出機能付き）
    ├── 顧問先追加
    ├── 基本設定
    ├── 項目の初期値の設定
    ├── バックアップ設定
    ├── CSVエクスポート
    ├── CSVインポート
    ├── 列幅リセット
    └── データベース初期化
  - その他アプリ
    ├── URL設定
    └── (動的に生成されるURLリンクボタン)

  詳細画面アコーディオン

  - データ管理メニュー
    ├── この年度の項目を確定
    ├── 項目を翌期以降に再反映
    ├── 削除された項目を自動削除
    ├── データ整合性チェック
    └── 項目の変更

  **分析機能画面**

  - **進捗管理ダッシュボード**: analytics.html
    ├── フィルター & アクションエリア: 多条件絞り込み
    ├── 動的サマリーダッシュボード: リアルタイム集計結果
    ├── 進捗マトリクス表: 事業者×年月のマトリクス
    └── 完全ソート機能: 全列でのソート対応

  - **担当者別パフォーマンスダッシュボード**: performance.html
    ├── 期間設定エリア: 柔軟な期間選択
    ├── パフォーマンス一覧表: 担当者別指標表示
    ├── 4段階評価システム: 視覚的パフォーマンス評価
    └── 詳細確認連携: 進捗ダッシュボードへの遷移

  詳細・編集画面

  - 月次進捗表: 12ヶ月分の進捗管理
  - カスタムタスク設定: ドラッグ&ドロップ対応
  - 年度確定ボタン: 動的表示制御
  - 編集ロック表示: 編集中ユーザーの表示
  - ステータス管理UI
  - モバイル最適化: 横画面推奨表示、固定要素無効化、タッチフレンドリーUI

  設定・カスタマイズ

  環境設定

  // Supabase設定（自動検出）
  const SUPABASE_URL = 'https://lqwjmlkkdddjnnxnlyfz.supabase.co'
  const SUPABASE_ANON_KEY = '[自動設定]'

  カスタマイズ可能項目

  - デフォルトタスク項目: 基本設定から変更可能
  - 担当者リスト: 動的追加・編集
  - 年度設定: 会計年度に応じた自動調整
  - UI色調: CSS変数での一括変更
  - 外部リンク: 「その他アプリ」メニューから自由に設定可能

  パフォーマンス

  - CDN配信: Vercel Edge Network, jsDelivr (SortableJS)

  (その他変更なし)

  最新の進捗（2025年9月15日更新）

#### 今回セッション（9/15）- UI/UX改善 & PDF最適化 & 進捗表示機能強化

1. **詳細画面JavaScript修正** - 完了
   - **変数名不一致修正**: `generalMemoField` → `generalMemoFieldField` で変数名統一
   - **URL自動リンク化エラー解決**: initializeAutoLinkify関数のReferenceError修正
   - **構文チェック**: JavaScriptエラーの完全解消

2. **担当者別パフォーマンス一覧機能改善** - 完了
   - **フィルタリング機能**: 担当クライアント数が0の担当者を非表示化
   - **表示最適化**: アクティブな担当者のみを一覧表示
   - **3つの関数修正**: displayPerformanceResults, sortTable, displaySortedResults

3. **進捗マトリクス表の視覚的改善** - 完了
   - **資料受付完了表示**: 分子が1の場合に📋アイコンを自動表示
   - **2箇所での実装**: メイン表示関数とPDF印刷用関数の両方に対応
   - **直感的UI**: 1/5 → 📋 1/5 で資料受付状況を一目で把握可能

4. **PDFエクスポート機能の大幅改善** - 完了
   - **ダッシュボード準拠デザイン**: 現在の画面と同じ見た目でPDF生成
   - **横向きレイアウト**: A4 landscape形式での最適化
   - **情報密度向上**: ヘッダー情報を1行に集約、サマリーを枠なし表示
   - **決算月表示**: サイトと同様の赤線表示（📅アイコン削除）
   - **年月列幅統一**: 50px固定で整列表示
   - **行高最適化**: セルパディング縮小（6px→2px）で情報量最大化

5. **週次進捗グラフ機能の設計** - 計画完了
   - **実装計画書作成**: 7ステップの詳細手順書を作成
   - **データベース設計**: weekly_progress_snapshots テーブル仕様策定
   - **フィルター連動**: 既存フィルター条件に完全対応
   - **Chart.js実装**: 折れ線グラフによる週次推移表示
   - **総所要時間**: 約2時間15分の実装予定

#### 過去セッション（9/14）- Supabase自動バックアップシステム完全構築

1. **24時間365日自動バックアップシステム構築完了** - 完了
   - **Supabase Edge Function実装**: TypeScript による daily-backup 関数作成・デプロイ
   - **pg_cron スケジューラ設定**: 毎日15:00 UTC（日本時間0:00）の自動実行
   - **環境変数設定**: SUPABASE_SERVICE_ROLE_KEY の適切な配置
   - **週次ローテーション**: Sunday-Saturday フォルダでの効率的ストレージ管理

2. **バックアップ履歴管理システム実装** - 完了
   - **backup_history テーブル作成**: 実行日時・ステータス・ファイル情報の完全記録
   - **Row Level Security (RLS)**: 認証ユーザーのみアクセス可能な安全設計
   - **監視・トラッキング機能**: 成功・失敗の詳細ログ管理

3. **開発環境・CLI整備完了** - 完了  
   - **Supabase CLI インストール**: Scoop パッケージマネージャー経由でのセットアップ
   - **プロジェクトリンク**: ローカル開発環境とリモートプロジェクトの接続
   - **マイグレーション管理**: SQL スクリプトによるデータベース構造変更の版数管理

4. **実運用テスト・動作確認完了** - 完了
   - **手動テスト成功**: アプリUI経由でのバックアップ実行（613レコード・308KB）
   - **ストレージ確認**: weekly/Sunday フォルダへの正常なファイル作成
   - **Edge Function動作確認**: 認証・データ取得・アップロードの全工程正常動作

#### 過去セッション（9/13）- UI改良・検索機能追加・計画策定

1. **詳細画面のレイアウト改良** - 完了
   - **テーブル間隔最適化**: URL・メモテーブルのタイトル削除、進捗テーブルとの間隔を5pxに縮小
   - **視覚的統合**: 2つのテーブルをより近接配置してコンパクトな表示を実現
   - **ユーザビリティ向上**: 画面スペースの効率的活用

2. **進捗管理ダッシュボードの検索機能拡張** - 完了  
   - **UI改良**: フィルタードロップダウンのサイズ拡大（padding: 8px→15px、font-size: 16px追加）
   - **事業者名検索**: 決算月フィルターの右に検索入力欄を追加
   - **リアルタイム検索**: 入力に応じた即座フィルタリング機能実装
   - **検索ロジック**: 大文字小文字を区別しない部分一致検索対応
   - **表示統合**: 検索条件をサマリー情報とエクスポート機能に反映

3. **モダン達成エフェクトの完全実装** - 完了
   - **アニメーション専門エージェント活用**: 10種類のGPU最適化エフェクトを実装
   - **パフォーマンス最適化**: will-change、translateZ(0)によるハードウェアアクセラレーション
   - **アクセシビリティ対応**: prefers-reduced-motion対応でモーションセンシティブユーザーに配慮
   - **モバイル最適化**: デバイス検出による適切なエフェクト調整

4. **自動保存機能の実装計画策定** - 計画完了
   - **スマートデバウンス方式**: 3秒間の入力停止後に自動保存実行
   - **対象フィールド**: タスクチェック・URL入力・メモ入力・ステータス変更
   - **実装手順書**: 6つのPhaseによる段階的実装計画を策定
   - **リスク対策**: エラーハンドリング、オフライン対応、ページ離脱防止を含む

5. **メイン画面移設の計画策定** - 計画完了  
   - **移設対象**: 現在のindex.htmlから analytics.htmlをメイン画面に変更
   - **移植機能**: 編集ボタン、データ管理メニュー、表示設定メニュー
   - **実装方式**: ファイル名変更またはリダイレクト方式の2つのオプション
   - **影響分析**: 認証フロー、ナビゲーション、パフォーマンス面での検討完了

#### 解決済み問題
- **ログイン後データ読み込み失敗**: 緊急ロールバックで解決
- **初期化無限ループ**: 原因特定済み（実装は一時保留）
- **横向きメッセージ表示**: PC環境での非表示化完了

#### 現在残っている問題・課題
- **パフォーマンス問題**: `loadPersonalSettings()`の大量呼び出し（90回以上）
- **初期化の安定性**: 認証状態変化時の重複初期化問題
- **バックアップレポート機能**: 安定化のため一時的に削除状態

#### 今回セッションで完成した機能・改善点（9/11）

1. **リアルタイムフィルタリング機能実装** - 完了
   - **進捗管理ダッシュボード**: フィルター変更時の自動集計機能
   - **担当者別パフォーマンスダッシュボード**: 期間選択時の自動分析機能
   - **デバウンス処理**: 300msの遅延で無駄な処理を防止
   - **初期表示**: ページアクセス時の自動データ表示

2. **エクスポート機能大幅改善** - 完了
   - **ソート状態反映**: 画面の並び替え順序をエクスポートに反映
   - **フィルター条件表示**: エクスポートファイルに検索条件と並び順を記載
   - **CSV最適化**: 分数データの日付変換問題を修正（5/5 → ="5/5"）
   - **全形式対応**: CSV・Excel・PDF全てでソート状態とフィルター情報を出力

3. **デフォルト決算月ソート機能** - 完了
   - **メイン画面準拠**: 現在月-2ヶ月を起点とした決算月順表示
   - **自動適用**: 初期表示とクリア時のデフォルトソート
   - **カスタムソート**: 決算月ソート時の起点からの距離計算

4. **UI/UX改善** - 完了
   - **フィルター情報表示**: 集計結果サマリーに現在の条件を表示
   - **視覚的改善**: 期間・担当者・決算月の条件を一目で確認可能
   - **レスポンシブ対応**: 小画面では2行表示に自動調整

#### 過去セッションで完成した機能・改善点（9/9）

1. **全体メモ機能実装** - 完了
   - **データベース拡張**: `clients`テーブルに`overall_memo`列を追加
   - **保存機能**: 詳細画面での全体メモ保存・読み込み機能
   - **変更検知**: 未保存変更警告システムに統合
   - **バックアップ対応**: 全体メモデータの自動バックアップ
   - **URL自動リンク化**: 全体メモ内URLの自動リンク対応

2. **Excelエクスポート機能改善** - 完了
   - **3種類のExcel形式**: シンプル・ヘッダー強調・進捗アイコン付き
   - **統合シート**: サマリーと進捗マトリクスを1シートに統合
   - **SheetJS制限対応**: 無料版の制限に対応した代替実装
   - **進捗視覚化**: アイコン（✅⚠️🔴）による進捗状況表示

3. **PDFエクスポート機能改善** - 完了
   - **横向きレイアウト**: A4 landscape形式での出力
   - **月次データ色分け**: 進捗率に応じた背景色表示（緑・黄・赤）
   - **詳細マトリクス表**: 事業者別・月別の詳細進捗表示
   - **色分け凡例**: PDF内に色分けの説明を表示

4. **進捗マトリクス表ソート機能拡張** - 完了
   - **担当者ソート**: 五十音順（昇順・降順）
   - **決算月ソート**: 数値順（昇順・降順）
   - **視覚的フィードバック**: ソートアイコン（▲▼）表示
   - **全列ソート対応**: 事業者名・進捗率・担当者・決算月・各月データ

#### 過去セッションの実装済み機能・改善点（9/8）

1. **分析機能の大幅改善・修正完了**
   - **ステータス構成計算ロジック修正**: 0/X進捗タスクを遅延・停滞として正しく検出
   - **担当者別パフォーマンス表修正**: ソート時のID列消失問題を解決
   - **デフォルトソート順変更**: ID昇順表示に統一
   - **分析画面レイアウト改善**: 左2/3・右1/3の最適バランス配置
   - **ステータス構成表示改善**: 円グラフと凡例を左右配置・縦3行表示
   - **サマリーカード最適化**: 縦幅短縮・コンパクト化
   - **要注意クライアント表示調整**: スクロール機能付き・表示幅最適化

2. **文字サイズ調整機能実装**
   - **個人設定**: ローカルストレージによる個別カスタマイズ
   - **UI配置**: 管理メニュー > 基本設定 > 個別設定内
   - **操作性**: －/＋ボタン・リセットボタン・リアルタイム表示更新
   - **調整範囲**: 70%～150%（5%刻み）
   - **適用範囲**: サイト全体のフォントサイズ統一制御
   - **永続化**: ブラウザ再起動後も設定維持

3. **分析ダッシュボードUI完成度向上**
   - **レイアウトバランス**: 集計サマリー・要注意一覧（左2/3）+ ステータス構成（右1/3）
   - **円グラフ改善**: サイズ最適化（200px→160px）+ 凡例縦配置
   - **凡例デザイン**: 「完了: X件 (X%)」形式の3行縦表示
   - **視覚的改善**: カラーインジケーター・アライメント調整

#### 過去セッションの実装済み機能（9/7）

4. **高度分析機能付き進捗管理ダッシュボード実装**
   - **フェーズ1: 進捗管理ダッシュボード**完全実装
     - analytics.html + analytics.js による専用画面
     - 多条件フィルター（期間・担当者・決算月）
     - 動的サマリー（全体進捗率・要注意クライアント自動検出）
     - 進捗マトリクス表（事業者×年月）
     - 完全ソート機能（事業者名・進捗率・月別進捗）
     - 月別進捗列の動的生成
     - カラーコード表示（緑/黄/赤）

   - **フェーズ2: 担当者別パフォーマンスダッシュボード**完全実装
     - performance.html + performance.js による専用画面
     - パフォーマンス指標（担当クライアント数・平均完了率・完了月数・遅延発生月数）
     - 4段階評価システム（優秀/良好/標準/要改善）
     - 柔軟期間設定（今年度・前四半期・6ヶ月・12ヶ月・カスタム）
     - 完全ソート機能（全指標対応）
     - 詳細確認連携（進捗ダッシュボードへの遷移）

5. **UI/UX向上**
   - 分析機能ボタンを独立配置（全員アクセス可能）
   - 進捗⟷パフォーマンスダッシュボード間の相互ナビゲーション
   - 視覚的ソートインジケーター（▲▼アイコン）
   - Toast通知による操作フィードバック

#### 過去の実装済み機能・改善点（9/6以前）

3. **固定テーブルヘッダー機能** ✅
   - スティッキーヘッダー実装：スクロール時でもテーブルヘッダーが常時表示
   - z-index調整：ドロップダウンメニューとの重複問題を解決
   - ユーザビリティ向上：大量データでの項目確認が容易に

2. **バックアップ・復元システムの完全実装** ✅
   - **週次ローテーション**: Monday-Sunday フォルダでの自動保存
   - **File System Access API対応**: 任意フォルダへの直接保存
   - **安全な復元処理**: 外部キー制約・担当者保持の完全対応
   - **データ整合性保証**: settings テーブル等特殊スキーマ対応
   - **エラー耐性**: Supabase制限（RLS、DELETE制約）への自動フォールバック
   - **詳細ログ**: 復元プロセスの透明化・デバッグ対応

3. **UI/UX改善** ✅
   - バックアップ管理モーダル：設定・実行・復元を統合
   - 削除スキップモード：Supabase制限回避の安全オプション
   - プログレス表示：バッチ処理の詳細進捗

4. **技術的品質向上** ✅
   - **テーブルスキーマ対応**: settings(key基準) vs その他(id基準)の統一処理
   - **バッチ処理最適化**: 50-100件単位での効率的データ処理
   - **レート制限対策**: API負荷軽減の待機時間制御
   - **コード整理**: CSV機能削除によるシンプル化・メンテナンス性向上

#### 技術的解決済み問題
- **settingsテーブルIDエラー**: `column settings.id does not exist` 完全解決
- **外部キー制約違反**: clients.staff_id の整合性維持機能
- **大量削除制限**: `DELETE requires a WHERE clause` 回避処理
- **RLS制限**: Row Level Security による403エラー対応
- **データ復元失敗**: 0件復元問題の根本解決

#### 過去の実装済み機能（継続）

5. **月次進捗ロジックの改善** - 完了（継続）
   - DBの`monthly_tasks`テーブルに`completed`フラグを追加し、より正確な進捗管理を実現。
   - メイン画面の進捗表示を`completed`フラグ基準の「最終完了年月」に変更。
   - 詳細画面でタスクを100%にして保存すると`completed`フラグが自動更新されるロジックを実装。

6. **その他アプリ連携機能** - 完了（継続）
   - 外部リンクを自由に登録・管理できる「URL設定」機能を追加。
   - ドラッグ＆ドロップによる表示順の並べ替えに対応。
   - 登録したリンクはメイン画面の「その他アプリ」メニュー内にボタンとして自動で表示される。

7. **UI改善** - 完了（継続）
   - メイン画面・詳細画面の全てのアコーディオンメニュー内のボタンテキストを中央揃えに統一。
   - 「その他アプリ」メニュー内で、「URL設定」ボタンと、ユーザーが追加したURLボタンが視覚的に区別しやすいように、区切り線と専用のボタンスタイルを追加。
   - **URL参照ボタンの視覚的向上**: 黄色のグラデーション背景・白文字・影効果によるモダンデザインに変更。

8. **データ整合性チェック機能** - 完了（継続）
   - フロントエンドとSupabaseデータベースの整合性を確認・修復する機能を実装。
   - 詳細画面のアコーディオンメニュー内「データ整合性チェック」ボタンから実行可能。
   - 不整合検出時の詳細レポート表示と自動修復機能。
   - **決算月対応**: クライアント固有の決算月に基づく正確な年度期間計算
   - **JSONパース対応**: データベースJSON文字列フィールドの適切な解析処理
   - **比較ロジック改善**: false vs undefined の適切な判定（一致として処理）
   - **完了ボタン機能**: 結果確認後の詳細画面への適切な復帰機能
   - **自動修復機能完全実装**: progress_inconsistency・obsolete_tasksの自動検出・修復対応。

9. **モバイル完全対応** - 完了（継続）
   - レスポンシブデザイン実装：メイン画面をカード形式レイアウトに自動変換。
   - タッチフレンドリーUI：44px以上のタップ対象、適切な間隔設定。
   - 詳細画面の横画面推奨：CSS rotation prompt による直感的な回転誘導。
   - モバイル専用最適化：固定要素の無効化、スクロール体験改善。

10. **画面方向管理の最適化** - 完了（継続）
    - Screen Orientation API の複雑なロック機能を削除し、デバイス互換性を向上。
    - CSS ベースの横画面推奨メッセージによる安定したUX提供。
    - デバイス制限による API エラー（NotSupportedError）を完全解消。

11. **基本設定モーダル機能の大幅改善** - 完了（継続）
    - **3列レイアウト**: 個別設定・共通設定・管理設定の論理的分類
    - **ローカルストレージ対応**: 個人設定（フォント・非表示設定・エフェクト）をlocalStorageで管理
    - **管理者権限制御**: 管理設定は管理者のみアクセス可能、視覚的フィードバック付き
    - **機能統合**: 散在していた管理機能を設定モーダル内に集約

12. **達成時エフェクト機能の大幅拡張** - 完了（継続）
    - **10種類のランダムエフェクト実装**: Canvas Confetti + カスタムエフェクトの豪華な組み合わせ
    - **Canvas Confetti統合**: 本格的なパーティクルエフェクトライブラリを導入
    - **多様なエフェクト**: 基本紙吹雪・星・カスタムシェイプ・絵文字・神々しい光・Good指・くす玉+ハト・音符ダンス・サーカス風船・トロフィー授与
    - **設定参照問題修正**: details.jsでの設定参照を統一し、正しく有効/無効制御
    - **アニメーション専門エージェント**: パフォーマンス最適化・アクセシビリティ対応の専門的レビュー実施

13. **テーブルソート機能の完全修復・モダン化** - 完了（継続）
    - **機能修復**: 「ドラッグして幅を調整」テキストによるソートキー認識問題を解決
    - **モダンアイコンデザイン**: 絵文字からSVGベースの美しいソートアイコンに刷新
    - **インタラクティブエフェクト**: ホバー時のスケール・色変更・背景色変化を実装
    - **視覚的フィードバック**: アクティブソート状態の明確な表示とスムーズなアニメーション

#### 技術的改善点
- **バックアップアーキテクチャ**: JSON形式統一・週次ローテーション・File System Access API
- **データ整合性システム**: テーブル別スキーマ対応・外部キー制約処理・upsert最適化
- **エラー回復機能**: Supabase制限の自動検出・フォールバック処理・詳細ログ
- **DBスキーマ拡張**: `app_links`テーブルを追加し、正規化されたデータ構造を維持。
- **外部ライブラリ導入**: CDN経由で`SortableJS`（ドラッグ＆ドロップ）・`Canvas Confetti`（達成時エフェクト）を導入。
- **モバイル対応アーキテクチャ**: Media Queries (@media screen and (max-width: 480px))による段階的拡張。
- **デバイス互換性**: Screen Orientation API の制限に対応した堅牢なフォールバック実装。
- **ストレージ戦略**: 個人設定はlocalStorage、共有設定はSupabaseの適切な分離。
- **SVGアイコンシステム**: スケーラブルで高DPI対応のアイコンデザイン採用。
- **動的文字列処理**: 正規表現を用いた柔軟なヘッダーテキスト解析機能。
- **Claude Code エージェント活用**: アニメーション専門エージェント（`.claude/agents/animation-expert.md`）による品質向上。

#### 次回以降の実装予定（優先順位順）

1. **週次進捗グラフ機能実装**【次回最優先】
   - weekly_progress_snapshotsテーブル作成
   - Chart.jsによる週次推移折れ線グラフ
   - フィルター条件連動（担当者・決算月・期間・事業者名）
   - スナップショット保存機能（手動・将来的に自動）
   - 前週比増減値表示機能

2. **悲観ロック機能の修復**
   - 編集競合防止システムの改善
   - 強制解除機能の最適化
   - タイムアウト処理の調整

3. **通知システム実装**
   - 期限接近アラート
   - 完了通知
   - システム更新通知

4. **詳細レポート機能**
   - 月次・年次レポート生成
   - PDF出力機能
   - カスタマイズ可能なレポートテンプレート

5. **高度検索機能**
   - 複合条件検索
   - 保存済み検索条件
   - 検索履歴管理

6. **パフォーマンス最適化**
   - 大量データ処理の高速化
   - キャッシュ戦略の改善
   - 遅延読み込み（Lazy Loading）の実装

#### 現在の完成度
- **基本機能**: 100%完成（全体メモ機能追加）
- **担当者管理機能**: 100%完成（CSV抽出機能・UI最適化完了）
- **データ整合性チェック**: 100%完成（決算月対応・JSONパース修正完了）
- **自動バックアップシステム**: 100%完成（Supabase Edge Functions + Cron Job）
- **手動バックアップ・復元**: 100%完成
- **UI/UX**: 100%完成（PDFエクスポート最適化・進捗表示改善完了）
- **モバイル対応**: 100%完成
- **データ管理**: 100%完成（自動バックアップシステム完全対応）
- **分析機能**: 100%完成（担当者フィルタリング・進捗表示改善完了）
- **エクスポート機能**: 100%完成（PDF最適化・ダッシュボード準拠デザイン完了）
- **カスタマイズ機能**: 100%完成（個人設定対応）
- **グラフ機能**: 30%完成（基本円グラフ実装済み・週次グラフ設計完了）
- **通知システム**: 0%（未実装）
- **高度機能**: 100%完成（進捗マトリクス視覚改善により完成）

(以下、変更なし)

## 次回セッションでの実装予定作業事項（2025年9月13日記録）

### **実装準備完了の機能（手順書あり）**

1. **スマートデバウンス自動保存機能の実装**
   - **対象画面**: 詳細画面（details.html）
   - **実装方式**: 3秒デバウンス + AutoSaveManagerクラス
   - **準備状況**: 完全な実装手順書（claude-autosave-implementation.txt）
   - **実装時間**: 約2.5時間（テスト含む）

2. **進捗管理ダッシュボードのメイン画面化**
   - **移設対象**: analytics.html → 新メイン画面
   - **移植機能**: 編集ボタン、管理メニュー、設定メニュー
   - **実装方式**: ファイル名変更方式（推奨）またはリダイレクト方式
   - **準備状況**: 詳細計画書（claude-change-to-main.txt）

### **継続課題（技術的問題）**

3. **パフォーマンス問題の段階的修正**
   - `getFilteredClients()`での`loadPersonalSettings()`最適化
   - ループ外での1回読み込みに変更
   - 小さな変更単位で動作確認を徹底

4. **初期化安定化の慎重な実装**
   - `isInitialized`フラグシステムの再実装
   - 認証状態変化時の重複初期化防止
   - 段階的テストで安定性を確認

5. **バックアップレポート機能の再実装**
   - 管理者向け詳細レポートモーダル
   - 1日1回自動表示システム
   - 手動トリガーボタン機能

### **作業優先順位**
1. **最優先**: 自動保存機能実装（ユーザビリティ大幅向上）
2. **高優先**: メイン画面移設（UI刷新）
3. **中優先**: パフォーマンス問題修正（安定性向上）
4. **低優先**: バックアップレポート機能復旧

### **現在の安定状態**
- **本番URL**: https://mori-jigyosya.vercel.app/
- **基本機能**: 正常動作確認済み
- **新機能**: 検索拡張・UI改良完了

---

## 開発時の注意
①commit分は短く英文で作成してください
②開発はステップバイステップで進めて下さい  
③良いアイデアがあったら教えてください
④**安定性を最優先**とし、問題発生時は即座にロールバックを実行してください

共有用完成
